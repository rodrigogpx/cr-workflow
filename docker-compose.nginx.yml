version: "3.8"

services:
  nginx:
    image: nginx:stable-alpine
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    networks:
      - cac360-public
    volumes:
      - nginx-certs:/etc/letsencrypt:ro
    configs:
      - source: nginx-conf
        target: /etc/nginx/conf.d/default.conf
        mode: 0444
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

networks:
  cac360-public:
    external: true

volumes:
  nginx-certs:
    driver: local

configs:
  nginx-conf:
    file: ./nginx/default.conf
