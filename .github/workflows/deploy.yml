name: CI/CD - Docker Swarm Deploy

on:
  push:
    branches:
      - main
      - hml
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'hml'
        type: choice
        options:
          - hml
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # BUILD & PUSH DOCKER IMAGE
  # ============================================
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "version=prod-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "version=hml-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_APP_TITLE=CAC 360
            VITE_APP_LOGO=/logo.png

  # ============================================
  # DEPLOY HOMOLOGA√á√ÉO (Docker Swarm)
  # ============================================
  deploy-hml:
    name: Deploy HML (Swarm)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/hml' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'hml')
    environment:
      name: homologacao
      url: https://hml.cac360.com.br

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Docker Swarm via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üöÄ Iniciando deploy HML no Docker Swarm..."
            
            # Vari√°veis
            export IMAGE_TAG="hml-${{ github.sha }}"
            export GITHUB_REPOSITORY="${{ github.repository }}"
            
            # Login no GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull da nova imagem
            docker pull ghcr.io/${{ github.repository }}:$IMAGE_TAG
            
            # Atualizar servi√ßo no Swarm
            if docker service ls | grep -q "cac360-hml_app"; then
              echo "Atualizando servi√ßo existente..."
              docker service update \
                --image ghcr.io/${{ github.repository }}:$IMAGE_TAG \
                --update-parallelism 1 \
                --update-delay 10s \
                --update-failure-action rollback \
                cac360-hml_app
            else
              echo "Stack n√£o encontrada. Deploy inicial..."
              cd /opt/cac360
              docker stack deploy -c docker-compose.swarm.yml --with-registry-auth cac360-hml
            fi
            
            # Aguardar e verificar deploy
            sleep 15
            docker service ls | grep cac360-hml
            
            echo "‚úÖ Deploy HML conclu√≠do!"

  # ============================================
  # DEPLOY PRODU√á√ÉO (Docker Swarm)
  # ============================================
  deploy-production:
    name: Deploy Production (Swarm)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://cac360.com.br

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Docker Swarm via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üöÄ Iniciando deploy PRODU√á√ÉO no Docker Swarm..."
            
            # Vari√°veis
            export IMAGE_TAG="prod-${{ github.sha }}"
            export GITHUB_REPOSITORY="${{ github.repository }}"
            
            # Login no GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull da nova imagem
            docker pull ghcr.io/${{ github.repository }}:$IMAGE_TAG
            docker pull ghcr.io/${{ github.repository }}:latest
            
            # Salvar imagem atual para rollback
            CURRENT_IMAGE=$(docker service inspect cac360_app --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' 2>/dev/null || echo "none")
            echo "$CURRENT_IMAGE" > /opt/cac360/config/.rollback-image
            
            # Atualizar servi√ßo no Swarm
            if docker service ls | grep -q "cac360_app"; then
              echo "Atualizando servi√ßo existente..."
              docker service update \
                --image ghcr.io/${{ github.repository }}:$IMAGE_TAG \
                --update-parallelism 1 \
                --update-delay 10s \
                --update-failure-action rollback \
                cac360_app
            else
              echo "Stack n√£o encontrada. Deploy inicial..."
              cd /opt/cac360
              docker stack deploy -c docker-compose.swarm.yml --with-registry-auth cac360
            fi
            
            # Aguardar e verificar deploy
            sleep 20
            docker service ls | grep cac360
            
            # Verificar sa√∫de
            TIMEOUT=90
            ELAPSED=0
            while [ $ELAPSED -lt $TIMEOUT ]; do
              RUNNING=$(docker service ls --filter "name=cac360_app" --format "{{.Replicas}}" | cut -d'/' -f1)
              DESIRED=$(docker service ls --filter "name=cac360_app" --format "{{.Replicas}}" | cut -d'/' -f2)
              
              if [ "$RUNNING" == "$DESIRED" ] && [ "$RUNNING" != "0" ]; then
                echo "‚úÖ Servi√ßo healthy! ($RUNNING/$DESIRED replicas)"
                break
              fi
              
              echo "Aguardando... ($RUNNING/$DESIRED replicas)"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done
            
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "‚ùå Timeout! Executando rollback autom√°tico..."
              docker service rollback cac360_app
              exit 1
            fi
            
            echo "‚úÖ Deploy PRODU√á√ÉO conclu√≠do!"

  # ============================================
  # NOTIFICA√á√ÉO
  # ============================================
  notify:
    name: Notify
    needs: [build, deploy-hml, deploy-production]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deploy Status
        run: |
          echo "Build: ${{ needs.build.result }}"
          echo "Deploy HML: ${{ needs.deploy-hml.result }}"
          echo "Deploy Prod: ${{ needs.deploy-production.result }}"
